<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Speedcooking</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Lora" rel="stylesheet"> 
  
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="./d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <style>
      svg {
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
      }
    </style>

  </head>
  <body>
    <nav id="nav" class="navbar navbar-dark bg-primary">
      <a class="navbar-brand" href="">SpeedCooking</a>
      <select class="selectRecipes"></select>
    </nav>


    <div class="container">
      <!-- Content here -->
      <svg></svg>
    </div>


    <script>

      var width = 900, 
          height = 500,
          margins = {top: 30, right: 20, left: 20, bottom: 20, inter_rect: 0}
          temp_internode_distance = 50,
          padding_right = 30;


      var svg = d3.select("svg")
        .attr("width", width)
        .attr("height", height)

      var select = d3.select("select");


      var recipe_chosen;
      var data_recipe;

      var color = d3.scaleOrdinal(d3.schemePastel1);

      d3.json("recettes.json", function(json) {

        data_recipe = json.recettes[0];
        // on en aura besoin avant de changer le form



        // Load the recipe chosen in the LOCAL variable data_recipe.
        select.on("change", function(){
            recipe_chosen = d3.select(".selectRecipes").node().value;

            // Put info with selected information.
            for (var i = 0; i< json.recettes.length; i++){
              if (json.recettes[i].nom == recipe_chosen) {
                data_recipe = json.recettes[i]
              }
            }
        });

        // Add all recipe chosen in the dropdown.
        select.selectAll("option").data(json.recettes).enter()
          .append("option")
          .attr("value", function(d) {return d.nom})
          .html(function(d) {return d.nom})




        // ajout des valeurs en x et y

        // x : calcul de profondeur
        /*var get_depth = function (i,etapes){
          d = 1;
          console.log("call withb i=");
          console.log(i);
          var children = etapes[i].enfants;
          children.forEach(function (c) {
            d_c = get_depth(c,etapes);
            if (d_c+1 > d) {
              d = d_c+1;
            }
          });
          console.log("return :");
          console.log(d);
          return d;
        };
        depth = get_depth(data_recipe.etapes.length-1,data_recipe.etapes);


        console.log(depth);*/






      

        var locations_obj = [{lieu: "plan de travail 1", id: 1},
        {lieu: "plaque de cuisson 1", id: 2},
        {lieu: "plan de travail 2", id: 3},
        {lieu: "four", id: 4},
        {lieu: "plan de travail 3", id: 5}] 

        locations_obj.sort(function(a, b) {
          return a.id - b.id;
        });



        // Create background for locations (four, plaque de travail 1, ...)
        var heigth_rect = (height - margins.top - margins.bottom) / locations_obj.length;

        locations = svg.selectAll(".locations").data(locations_obj).enter()
          .append("g")
            .attr("class", "locations")
            .attr("transform", function(d, i) {
              var translateY = parseInt(margins.top) + i*(heigth_rect + margins.inter_rect); 
              return "translate(" + margins.left + "," + translateY + ")"
            })

        locations.append("rect")
          .attr("class", function(d){return d.lieu})
          .attr("width", function(){return width - margins.right - margins.left})
          .attr("height", function(d){return heigth_rect})
          .attr("x", 0)
          .attr("y", 0)
          .attr("fill", function(d,i){
            console.log(i%2)
            if (i%2 !== 0){
              return "#eee"
            } else {
              return "#bbb"
            }
          })
          .style("opacity", 0.5)

        locations.append("text")
          .style("font-weight", "bold") 
          .attr("class", "location_title") 
          .attr("transform", function(d, i) { 
            return "translate(3,18)"
          })
          .html(function(d){return capitalize(d.lieu)})


        // Store strings of locations in all_locations
        var all_locations = []
        data_recipe.etapes.forEach(function(d,i){
          if (!all_locations.includes(d.lieu)){
            all_locations.push(d.lieu)
          }
        })
        
        // Add in location_obj the nodes classified.
        locations_obj.forEach(function(location,j){
            location.etapes = [];
          })

        data_recipe.etapes.forEach(function(etape,i){
          locations_obj.forEach(function(location,j){
            if (location.lieu === etape.lieu){
              location.etapes.push(etape.identifiant)
            }
          })
        })




        var nodes = svg.selectAll(".node").data(data_recipe.etapes).enter()
          .append("g")
          .attr("class", "node")
          .attr("transform", function(d){

            // Get the id of the y position of the node.
            for (var ind = 0; ind < locations_obj.length; ind++){
              if (locations_obj[ind].lieu === d.lieu){
                var y_index = locations_obj[ind].id;
              }
            }
            // Get the x position of the node in the grid 
            //TODO
            var x_index = 0

            var x = margins.left + padding_right + temp_internode_distance * x_index;
            var y = margins.top + (heigth_rect + margins.inter_rect) * (y_index - 1/2);
            return "translate(" + x + "," + y + ")"
          })
        
        nodes.append('rect')
          .attr("width", "10")
          .attr("height", "10")
          .attr("fill", "red")
          
        nodes.append("text")
          .html(function(d){
            return d.identifiant + ": " + capitalize(d.description_courte)
          })
          


        console.log(data_recipe)
        console.log(locations_obj)




      })



    function capitalize(string) { 
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    </script>


  </body>
</html>
